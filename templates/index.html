<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Aula de Armon√≠a</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=1">
    <!-- Estilos -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css?v=2.0.0">
    <!-- Tone.js CDN (v14.8.49 - Abril 2025) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- VexFlow para notaci√≥n musical (v5.0.0 - Migrado 31 Dic 2024) -->
    <script src="https://cdn.jsdelivr.net/npm/vexflow@5.0.0/build/cjs/vexflow.js"></script>
</head>

<!-- ========================================
     AULA DE ARMON√çA - HTML Principal
     Versi√≥n: 2.0 (Phase 2 Complete)
     √öltima actualizaci√≥n: Diciembre 2025
     ======================================== -->

<body>

    <!-- MODAL ONBOARDING -->
    <div class="modal-overlay" id="modal-welcome">
        <div class="modal-content">
            <h2>Bienvenido a Aula de Armon√≠a</h2>
            <p>Escribe acordes de 4 voces (SATB) y obt√©n an√°lisis autom√°tico de reglas de armon√≠a tonal.</p>
            <div class="shortcuts-list">
                <p style="margin: 0 0 8px 0; font-weight: bold; font-size: 0.9rem;">Atajos de teclado:</p>
                <div class="shortcut">
                    <span>Seleccionar voces:</span>
                    <span><kbd>1</kbd> <kbd>2</kbd> <kbd>3</kbd> <kbd>4</kbd></span>
                </div>
                <div class="shortcut">
                    <span>Navegar:</span>
                    <span><kbd>‚Üê</kbd> <kbd>‚Üí</kbd></span>
                </div>
                <div class="shortcut">
                    <span>Notas (A-G) + Octava:</span>
                    <span><kbd>C</kbd> <kbd>D</kbd> <kbd>E</kbd>...</span>
                </div>
                <div class="shortcut">
                    <span>Borrar nota:</span>
                    <span><kbd>Backspace</kbd></span>
                </div>
                <div class="shortcut">
                    <span>Analizar:</span>
                    <span><kbd>Enter</kbd></span>
                </div>
                <div class="shortcut">
                    <span>Volver a Escribir:</span>
                    <span><kbd>Esc</kbd></span>
                </div>
                <div class="shortcut">
                    <span>Deshacer/Rehacer:</span>
                    <span><kbd>Ctrl</kbd>+<kbd>Z</kbd> / <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Z</kbd></span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn-modal btn-modal-secondary" onclick="AudioStudio.closeWelcome()">M√°s tarde</button>
                <button class="btn-modal btn-modal-primary" onclick="AudioStudio.closeWelcome()">Comenzar</button>
            </div>
        </div>
    </div>

    <header>
        <h1>Aula de Armon√≠a</h1>
        <div class="header-controls">
            <!-- Selector de Tonalidad (Dropdown personalizado 2 columnas) -->
            <div class="tonality-dropdown" id="tonality-dropdown">
                <button class="tonality-trigger" id="tonality-trigger" onclick="AudioStudio.toggleTonalityDropdown()">
                    <span id="tonality-label">Do M</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div class="tonality-menu" id="tonality-menu">
                    <div class="tonality-header">
                        <span>Mayor</span>
                        <span>menor</span>
                    </div>
                    <!-- Ciclo de quintas: 7# a 7b -->
                    <div class="tonality-row" data-major="C#-major" data-minor="A#-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('C#-major', 'Do‚ôØ M')">Do‚ôØ M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('A#-minor', 'La‚ôØ m')">La‚ôØ m</span>
                    </div>
                    <div class="tonality-row" data-major="F#-major" data-minor="D#-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('F#-major', 'Fa‚ôØ M')">Fa‚ôØ M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('D#-minor', 'Re‚ôØ m')">Re‚ôØ m</span>
                    </div>
                    <div class="tonality-row" data-major="B-major" data-minor="G#-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('B-major', 'Si M')">Si M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('G#-minor', 'Sol‚ôØ m')">Sol‚ôØ m</span>
                    </div>
                    <div class="tonality-row" data-major="E-major" data-minor="C#-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('E-major', 'Mi M')">Mi M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('C#-minor', 'Do‚ôØ m')">Do‚ôØ m</span>
                    </div>
                    <div class="tonality-row" data-major="A-major" data-minor="F#-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('A-major', 'La M')">La M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('F#-minor', 'Fa‚ôØ m')">Fa‚ôØ m</span>
                    </div>
                    <div class="tonality-row" data-major="D-major" data-minor="B-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('D-major', 'Re M')">Re M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('B-minor', 'Si m')">Si m</span>
                    </div>
                    <div class="tonality-row" data-major="G-major" data-minor="E-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('G-major', 'Sol M')">Sol M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('E-minor', 'Mi m')">Mi m</span>
                    </div>
                    <div class="tonality-row selected" data-major="C-major" data-minor="A-minor">
                        <span class="ton-major active" onclick="AudioStudio.selectTonality('C-major', 'Do M')">Do
                            M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('A-minor', 'La m')">La m</span>
                    </div>
                    <div class="tonality-row" data-major="F-major" data-minor="D-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('F-major', 'Fa M')">Fa M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('D-minor', 'Re m')">Re m</span>
                    </div>
                    <div class="tonality-row" data-major="Bb-major" data-minor="G-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('Bb-major', 'Si‚ô≠ M')">Si‚ô≠ M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('G-minor', 'Sol m')">Sol m</span>
                    </div>
                    <div class="tonality-row" data-major="Eb-major" data-minor="C-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('Eb-major', 'Mi‚ô≠ M')">Mi‚ô≠ M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('C-minor', 'Do m')">Do m</span>
                    </div>
                    <div class="tonality-row" data-major="Ab-major" data-minor="F-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('Ab-major', 'La‚ô≠ M')">La‚ô≠ M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('F-minor', 'Fa m')">Fa m</span>
                    </div>
                    <div class="tonality-row" data-major="Db-major" data-minor="Bb-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('Db-major', 'Re‚ô≠ M')">Re‚ô≠ M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('Bb-minor', 'Si‚ô≠ m')">Si‚ô≠ m</span>
                    </div>
                    <div class="tonality-row" data-major="Gb-major" data-minor="Eb-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('Gb-major', 'Sol‚ô≠ M')">Sol‚ô≠ M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('Eb-minor', 'Mi‚ô≠ m')">Mi‚ô≠ m</span>
                    </div>
                    <div class="tonality-row" data-major="Cb-major" data-minor="Ab-minor">
                        <span class="ton-major" onclick="AudioStudio.selectTonality('Cb-major', 'Do‚ô≠ M')">Do‚ô≠ M</span>
                        <span class="ton-minor" onclick="AudioStudio.selectTonality('Ab-minor', 'La‚ô≠ m')">La‚ô≠ m</span>
                    </div>
                </div>
            </div>
            <!-- Toggle Modo -->
            <div class="mode-toggle">
                <button id="btn-mode-write" class="active" onclick="AudioStudio.setAppMode('write')"><span
                        class="btn-icon">‚úèÔ∏è</span><span class="btn-text"> Escribir</span></button>
                <button id="btn-mode-review" onclick="AudioStudio.setAppMode('review')"><span
                        class="btn-icon">üîç</span><span class="btn-text"> Revisar</span></button>
            </div>

            <button class="btn-undo write-only" id="btn-undo" onclick="AudioStudio.undo()"
                data-tooltip="Deshacer (Ctrl+Z)" disabled>‚Ü∂</button>
            <button class="btn-redo write-only" id="btn-redo" onclick="AudioStudio.redo()"
                data-tooltip="Rehacer (Ctrl+Shift+Z)" disabled>‚Ü∑</button>
            <!-- Bot√≥n Borrar (M√≥vil/Desktop) -->
            <button class="btn-undo btn-trash-header write-only desktop-only" onclick="borrarTodo()"
                data-tooltip="Borrar todo">üóëÔ∏è</button>

            <label class="auto-flow-switch write-only">
                <input type="checkbox" id="chk-autoflow" checked> Auto
            </label>

            <!-- Contextual Header (Desktop Only) -->
            <div class="header-context review-only desktop-only">
                <div class="header-error-badge" id="header-error-badge">
                    <span class="badge-icon">‚ö†Ô∏è</span>
                    <span class="badge-text" id="header-error-text">0 errores</span>
                </div>
                <button class="btn-quick-play desktop-only" onclick="reproducirPartitura()">
                    ‚ñ∂ Play
                </button>
            </div>
        </div>
    </header>

    <section id="stage">
        <div class="scroll-partitura" id="contenedor-scroll">
            <div class="partitura-wrapper">
                <div id="lienzo-partitura"></div>
                <div id="grados-container" class="grados-container"></div>
            </div>
            <div id="tooltip-error"></div>
        </div>
    </section>

    <section id="deck">
        <!-- Panel Resultados -->
        <div id="panel-resultados">
            <div id="resumen-errores" class="error-header">Informe</div>
            <div id="lista-errores"></div>
        </div>

        <!-- Fila A: Navegaci√≥n + Voces -->
        <div class="toolbar-row">
            <div class="nav-group">
                <button class="btn-nav" onclick="moverCursor(-1)" data-tooltip="Anterior (‚Üê)">‚ùÆ</button>
                <div id="indicador-posicion">C.1 - T.1</div>
                <button class="btn-nav" onclick="moverCursor(1)" data-tooltip="Siguiente (‚Üí)">‚ùØ</button>
            </div>

            <div class="voices-group">
                <button class="btn-voz" id="btn-B" data-key="1" onclick="seleccionarVoz('B')"
                    data-tooltip="Bajo (1)">B</button>
                <button class="btn-voz" id="btn-T" data-key="2" onclick="seleccionarVoz('T')"
                    data-tooltip="Tenor (2)">T</button>
                <button class="btn-voz" id="btn-A" data-key="3" onclick="seleccionarVoz('A')"
                    data-tooltip="Contralto (3)">A</button>
                <button class="btn-voz" id="btn-S" data-key="4" onclick="seleccionarVoz('S')"
                    data-tooltip="Soprano (4)">S</button>
            </div>
        </div>

        <!-- Fila B: Piano / Input -->
        <div class="piano-row">
            <!-- Modo Botones (m√≥vil) -->
            <div id="mobile-input-grid" class="mobile-input-grid">
                <div class="row">
                    <button class="btn-note" onclick="AudioStudio.inputNote('C')">Do</button>
                    <button class="btn-note" onclick="AudioStudio.inputNote('D')">Re</button>
                    <button class="btn-note" onclick="AudioStudio.inputNote('E')">Mi</button>
                    <button class="btn-note" onclick="AudioStudio.inputNote('F')">Fa</button>
                    <button class="btn-note" onclick="AudioStudio.inputNote('G')">Sol</button>
                    <button class="btn-note" onclick="AudioStudio.inputNote('A')">La</button>
                    <button class="btn-note" onclick="AudioStudio.inputNote('B')">Si</button>
                </div>
                <!-- Alteraciones Compactas -->
                <div class="row row-compact">
                    <div class="accidental-group">
                        <button id="btn-alt-sharp" class="btn-alt" onclick="AudioStudio.setAlteracion('#')">‚ôØ</button>
                        <button id="btn-alt-flat" class="btn-alt" onclick="AudioStudio.setAlteracion('b')">‚ô≠</button>
                        <button id="btn-alt-natural" class="btn-alt active"
                            onclick="AudioStudio.setAlteracion('n')">‚ôÆ</button>
                    </div>
                    <!-- Octava Mini -->
                    <div class="octave-group">
                        <button class="btn-mini" onclick="AudioStudio.changeOctave(-1)">‚àí</button>
                        <span id="mobile-octava" class="oct-display">3</span>
                        <button class="btn-mini" onclick="AudioStudio.changeOctave(1)">+</button>
                    </div>
                </div>
            </div>

            <div class="piano-container">
                <div class="piano-wrapper">
                    <div class="white-keys">
                        <div class="key-white" id="key-C" onclick="tocarBlanca('C')"><span>Do</span></div>
                        <div class="key-white" id="key-D" onclick="tocarBlanca('D')"><span>Re</span></div>
                        <div class="key-white" id="key-E" onclick="tocarBlanca('E')"><span>Mi</span></div>
                        <div class="key-white" id="key-F" onclick="tocarBlanca('F')"><span>Fa</span></div>
                        <div class="key-white" id="key-G" onclick="tocarBlanca('G')"><span>Sol</span></div>
                        <div class="key-white" id="key-A" onclick="tocarBlanca('A')"><span>La</span></div>
                        <div class="key-white" id="key-B" onclick="tocarBlanca('B')"><span>Si</span></div>
                        <div class="key-white" onclick="tocarDoAgudo()"><span>Do+</span></div>
                    </div>
                    <div class="key-black kb-Cs" id="key-C#" onclick="tocarNegra('C', 'D')"></div>
                    <div class="key-black kb-Ds" id="key-D#" onclick="tocarNegra('D', 'E')"></div>
                    <div class="key-black kb-Fs" id="key-F#" onclick="tocarNegra('F', 'G')"></div>
                    <div class="key-black kb-Gs" id="key-G#" onclick="tocarNegra('G', 'A')"></div>
                    <div class="key-black kb-As" id="key-A#" onclick="tocarNegra('A', 'B')"></div>
                </div>
            </div>

            <!-- Side Controls (Desktop Only) -->
            <div class="side-controls desktop-only">
                <div class="ctrl-capsule">
                    <span class="ctrl-label">Oct</span>
                    <button class="btn-mini" onclick="cambiarOctava(-1)" data-tooltip="Oct -">‚àí</button>
                    <span id="display-octava"
                        style="font-weight:bold; font-size:0.9rem; width:15px; text-align:center;">3</span>
                    <button class="btn-mini" onclick="cambiarOctava(1)" data-tooltip="Oct +">+</button>
                </div>
                <div class="ctrl-capsule">
                    <div class="switch-alt">
                        <label><input type="radio" name="alt" value="#"
                                onchange="AudioStudio.setAlteracion('#')"><span>‚ôØ</span></label>
                        <label><input type="radio" name="alt" value="b"
                                onchange="AudioStudio.setAlteracion('b')"><span>‚ô≠</span></label>
                        <label><input type="radio" name="alt" value="n" checked
                                onchange="AudioStudio.setAlteracion('n')"><span>‚ôÆ</span></label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Bar: Ahora contiene diferentes controles seg√∫n el modo -->
        <div class="action-bar">
            <!-- Mobile Mode Controls (Escribir/Revisar) - Visible en modo ESCRIBIR -->
            <div class="mode-controls-mobile">
                <button id="btn-mode-write-mobile" class="btn-mode-mobile active"
                    onclick="AudioStudio.setAppMode('write')">
                    ‚úèÔ∏è Escribir
                </button>
                <button id="btn-mode-review-mobile" class="btn-mode-mobile" onclick="AudioStudio.setAppMode('review')">
                    üîç Revisar
                </button>
                <button class="btn-trash-mobile" onclick="AudioStudio.clearAll()">
                    üóëÔ∏è Borrar
                </button>
            </div>

            <!-- Playback Controls - Visible en modo REVISAR -->
            <div class="playback-group" id="bottom-playback">
                <!-- Navigation buttons (desktop only) -->
                <button class="btn-nav-small desktop-only" onclick="AudioStudio.prevCompas()"
                    data-tooltip="Comp√°s Anterior">‚èÆ</button>

                <!-- Main playback controls -->
                <button class="btn-nav" onclick="reproducirPartitura()" data-tooltip="Reproducir (Espacio)">‚ñ∂</button>
                <button class="btn-nav" onclick="pausarPartitura()" data-tooltip="Pausar (P)">‚è∏</button>
                <button class="btn-nav" onclick="detenerPartitura()" data-tooltip="Detener (Espacio)">‚èπ</button>

                <!-- Navigation buttons (desktop only) -->
                <button class="btn-nav-small desktop-only" onclick="AudioStudio.nextCompas()"
                    data-tooltip="Comp√°s Siguiente">‚è≠</button>

                <!-- Loop toggle (desktop only) -->
                <button id="btn-loop" class="btn-feature desktop-only" onclick="AudioStudio.toggleLoop()"
                    data-tooltip="Modo Loop">
                    <span class="feature-icon">üîÑ</span>
                    <span class="feature-text">Loop</span>
                </button>

                <!-- Speed control (desktop only) -->
                <div class="speed-control desktop-only">
                    <label>Velocidad:</label>
                    <select id="playback-speed" onchange="AudioStudio.setPlaybackSpeed(this.value)">
                        <option value="0.5">50%</option>
                        <option value="0.75">75%</option>
                        <option value="1" selected>100%</option>
                        <option value="1.25">125%</option>
                    </select>
                </div>

                <!-- BPM control -->
                <div class="bpm-control" data-tooltip="Tempo (BPM)">
                    <span class="bpm-label">‚ô©=</span>
                    <input type="number" id="bpm-input" value="120" min="40" max="240" step="5"
                        onchange="AudioStudio.setBpm(this.value)">
                </div>
            </div>

            <!-- Desktop Action Buttons - Only visible on desktop -->
            <div class="desktop-actions">
                <button id="btn-corregir" class="btn-main btn-check" onclick="AudioStudio.analyzePartiture()">
                    ‚úÖ Corregir
                </button>
                <button class="btn-main btn-danger" onclick="AudioStudio.clearAll()">
                    üóëÔ∏è Borrar
                </button>
            </div>
        </div>
    </section>

    <!-- Error Sidebar (Desktop Only) -->
    <aside id="error-sidebar" class="error-sidebar">
        <div class="sidebar-toggle-btn" onclick="AudioStudio.toggleErrorSidebar()">
            <span class="error-count-badge" id="sidebar-error-count">0</span>
            <span class="toggle-icon">üìã</span>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-header">
                <h3>Errores Detectados</h3>
                <button class="btn-close-sidebar" onclick="AudioStudio.toggleErrorSidebar()">‚úï</button>
            </div>
            <div id="sidebar-error-list" class="error-list-sidebar">
                <!-- Errors populated dynamically -->
                <div class="no-errors-sidebar">No se han detectado errores</div>
            </div>
        </div>
    </aside>

    <!-- JavaScript de la aplicaci√≥n -->
    <script type="module" src="/static/js/app.js?v=2.0.0"></script>
</body>

</html>